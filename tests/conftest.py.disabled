# Copyright (c) 2025 FLEXT Team
# Licensed under the MIT License
# SPDX-License-Identifier: MIT

"""Modern test configuration using pytest patterns.

Clean, minimal test setup following enterprise standards.
ZERO TOLERANCE: NO SKIPS - All tests must run with real Oracle infrastructure.
"""

from __future__ import annotations

import asyncio
import os
import sys
from pathlib import Path
from typing import Any

import pytest

# Add src directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from flext_db_oracle import FlextDbOracleConfig


@pytest.fixture(scope="session")
def oracle_e2e_environment() -> dict[str, str]:
    """Ensure Oracle E2E environment is available.

    ZERO TOLERANCE: This fixture MUST provide working Oracle configuration.
    NO SKIPS allowed - tests will use real Oracle infrastructure.
    """
    # Check if Oracle E2E is already running
    try:
        async def _run(cmd: list[str], cwd: str | None = None, timeout: int | None = None) -> tuple[int, str, str]:
            process = await asyncio.create_subprocess_exec(
                *cmd,
                cwd=cwd,
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE,
            )
            try:
                stdout, stderr = await asyncio.wait_for(process.communicate(), timeout=timeout)
            except asyncio.TimeoutError:
                process.kill()
                await process.communicate()
                raise
            return process.returncode, stdout.decode(), stderr.decode()

        rc, out, _err = asyncio.run(
            _run([
                "docker",
                "ps",
                "--filter",
                "name=flext-oracle-db-e2e",
                "--format",
                "{{.Names}}",
            ]),
        )
        if rc == 0 and "flext-oracle-db-e2e" in out:
            return {
                "ORACLE_HOST": "localhost",
                "ORACLE_PORT": "1521",
                "ORACLE_SERVICE_NAME": "FLEXT_PDB",
                "ORACLE_USERNAME": "FLEXT_USER",
                "ORACLE_PASSWORD": "FlextTest123!",
                "ORACLE_SCHEMA": "FLEXT_TEST",
            }
    except Exception:
        pass

    # Start Oracle E2E infrastructure
    docker_dir = Path(__file__).parent.parent.parent / "docker"
    compose_file = docker_dir / "docker-compose.oracle-e2e.yml"

    if not compose_file.exists():
        pytest.fail(f"Oracle E2E infrastructure not found: {compose_file}")

    try:
        # Start Oracle database
        rc_up, _o1, err1 = asyncio.run(
            _run([
                "docker",
                "compose",
                "-f",
                str(compose_file),
                "up",
                "-d",
                "oracle-db",
            ], cwd=str(docker_dir)),
        )
        if rc_up != 0:
            pytest.fail(f"docker compose up failed: {err1}")

        # Wait for Oracle to be healthy
        rc_wait, _o2, err2 = asyncio.run(
            _run([
                "docker",
                "compose",
                "-f",
                str(compose_file),
                "exec",
                "-T",
                "oracle-db",
                "bash",
                "-c",
                "until sqlplus -s sys/Oracle123!@localhost:1521/FLEXT_PDB as sysdba <<< 'SELECT 1 FROM DUAL;' | grep -q '1'; do sleep 5; done",
            ], cwd=str(docker_dir), timeout=300),
        )
        if rc_wait != 0:
            pytest.fail(f"oracle health check failed: {err2}")

        return {
            "ORACLE_HOST": "localhost",
            "ORACLE_PORT": "1521",
            "ORACLE_SERVICE_NAME": "FLEXT_PDB",
            "ORACLE_USERNAME": "FLEXT_USER",
            "ORACLE_PASSWORD": "FlextTest123!",
            "ORACLE_SCHEMA": "FLEXT_TEST",
        }

    except Exception as e:
        pytest.fail(f"Failed to start Oracle E2E infrastructure: {e}")


@pytest.fixture(autouse=True)
def oracle_env_vars(oracle_e2e_environment: dict[str, str]) -> None:
    """Auto-configure Oracle environment variables for all tests.

    ZERO TOLERANCE: All tests get real Oracle configuration automatically.
    """
    for key, value in oracle_e2e_environment.items():
        os.environ[key] = value


@pytest.fixture
def oracle_config() -> dict[str, object]:
    """Provide REAL Oracle configuration for testing.

    ZERO TOLERANCE: Uses actual Oracle E2E environment, no mocks.
    """
    return {
        "connection": {
            "host": os.getenv("ORACLE_HOST", "localhost"),
            "port": int(os.getenv("ORACLE_PORT", "1521")),
            "service_name": os.getenv("ORACLE_SERVICE_NAME", "FLEXT_PDB"),
            "username": os.getenv("ORACLE_USERNAME", "FLEXT_USER"),
            "password": os.getenv("ORACLE_PASSWORD", "FlextTest123!"),
            "oracle_schema": os.getenv("ORACLE_SCHEMA", "FLEXT_TEST"),
        },
        "performance": {
            "batch_size": 1000,
            "pool_size": 5,
        },
        "table": {
            "load_method": "append-only",
            "create_indexes": True,
        },
        "log_level": "DEBUG",
    }


@pytest.fixture
def oracle_config_instance(oracle_config: dict[str, object]) -> FlextDbOracleConfig:
    """Create OracleConfig instance from REAL Oracle configuration."""
    # Extract flat configuration from nested structure
    connection = oracle_config["connection"]
    return FlextDbOracleConfig(
        host=connection["host"],
        port=connection["port"],
        service_name=connection["service_name"],
        username=connection["username"],
        password=connection["password"],
    )


@pytest.fixture
def flat_oracle_config() -> dict[str, object]:
    """Provide flat Oracle configuration for Singer SDK compatibility.

    ZERO TOLERANCE: Uses REAL Oracle environment variables.
    """
    return {
        # Singer SDK expects flat configuration
        "host": os.getenv("ORACLE_HOST", "localhost"),
        "port": int(os.getenv("ORACLE_PORT", "1521")),
        "service_name": os.getenv("ORACLE_SERVICE_NAME", "FLEXT_PDB"),
        "username": os.getenv("ORACLE_USERNAME", "FLEXT_USER"),
        "password": os.getenv("ORACLE_PASSWORD", "FlextTest123!"),
        "schema": os.getenv("ORACLE_SCHEMA", "FLEXT_TEST"),
        "batch_size": 1000,
        "pool_size": 5,
        "load_method": "append-only",
        "log_level": "DEBUG",
    }


@pytest.fixture
def sample_schema() -> dict[str, object]:
    """Provide sample Singer schema for testing."""
    return {
        "type": "object",
        "properties": {
            "id": {"type": "integer"},
            "name": {"type": "string", "maxLength": 100},
            "email": {"type": "string", "maxLength": 255},
            "created_at": {"type": "string", "format": "date-time"},
            "active": {"type": "boolean"},
        },
        "required": ["id", "name"],
    }


@pytest.fixture
def sample_records() -> list[dict[str, object]]:
    """Provide sample Singer records for testing."""
    return [
        {
            "id": 1,
            "name": "John Doe",
            "email": "john@example.com",
            "created_at": "2024-01-01T00:00:00Z",
            "active": True,
        },
        {
            "id": 2,
            "name": "Jane Smith",
            "email": "jane@example.com",
            "created_at": "2024-01-02T00:00:00Z",
            "active": False,
        },
    ]
